{{- /* ============ Per-table model generator (multi-schema aware) ============ */ -}}
{{- define "Model" }}
{{- $ctx  := . -}}
{{- $t    := $ctx.table -}}
{{- $root := $ctx.root  -}}
{{- $schema  := $ctx.schema -}}
{{- $hasUUIDPK := false -}}
{{- /* ===== user_profiles → UserProfile ===== */ -}}
{{- $tableName := exec "Title" $t.Name | exec "Singular" -}}
{{- $schemaName := lower $schema.Name -}}
{{- $fileName := printf "%s__%s.go" $schemaName (lower $t.Name) -}}

-- {{ $fileName }} --
// Code generated by gen-models. DO NOT EDIT.
package models

import (
  "github.com/google/uuid"
  "gorm.io/datatypes"
  "gorm.io/gorm"
  "time"
)

type {{ $tableName }} struct {
  {{- range $c := $t.Columns }}
    {{- $col := $c.Name -}}
    {{- $field := exec "FieldName" $col -}}
    {{- $goType := exec "ResolveType" (dict "root" $root "col" $c "schema" $schema) -}}

    {{- /* UUID primary key detect */ -}}
    {{- if and (eq $col "id") (eq $goType "uuid.UUID") -}}
      {{- $isPK := false -}}
      {{- if $t.PrimaryKey -}}
        {{- range $p := $t.PrimaryKey.Parts -}}
          {{- if and $p.C (eq $p.C.Name $col) -}}
            {{- $isPK = true -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      {{- if $isPK }}{{ $hasUUIDPK = true }}{{ end }}
    {{- end }}

    {{- /* Special columns */ -}}
    {{- if eq $col "deleted_at" -}}
      {{- printf "\n    %s %s `gorm:\"index\"`" "DeletedAt" "gorm.DeletedAt" -}}
      {{- continue -}}
    {{- end -}}

    {{- if eq $col "created_at" -}}
      {{- printf "\n    %s %s `gorm:\"autoCreateTime\"`" $field "time.Time" -}}
      {{- continue -}}
    {{- end -}}

    {{- if eq $col "updated_at" -}}
      {{- printf "\n    %s %s `gorm:\"autoUpdateTime\"`" $field "time.Time" -}}
      {{- continue -}}
    {{- end -}}

    {{- /* Assemble gorm tags */ -}}
    {{- $tags := list -}}
    {{- $ctypeRaw := columnType $c -}}
    {{- if $ctypeRaw -}}
      {{- $ctype := exec "NormalizeDbTypeFull" $ctypeRaw -}}
      {{- $tags = append $tags (printf "type:%s" $ctype) -}}
    {{- end -}}

    {{- /* primaryKey tag */ -}}
    {{- $isPK := false -}}
    {{- if $t.PrimaryKey -}}
      {{- range $p := $t.PrimaryKey.Parts -}}
        {{- if and $p.C (eq $p.C.Name $col) -}}
          {{- $isPK = true -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $isPK -}}
      {{- $tags = append $tags "primaryKey" -}}
    {{- end -}}
    
    {{- /* index / uniqueIndex —— only output priority when it's a composite index (column order starts from 1) */ -}}
    {{- range $idx := $t.Indexes -}}
      {{- $belongs := false -}}
      {{- $prio := 0 -}}
      {{- $partsCount := len $idx.Parts -}}
      {{- $isComposite := gt $partsCount 1 -}}

      {{- /* find the position of the current column in the index (1-based) */ -}}
      {{- range $i, $part := $idx.Parts -}}
        {{- if and $part.C (eq $part.C.Name $col) -}}
          {{- $belongs = true -}}
          {{- $prio = add $i 1 -}}
        {{- end -}}
      {{- end -}}

      {{- if $belongs -}}
        {{- if $idx.Unique -}}
          {{- if $idx.Name -}}
            {{- if $isComposite -}}
              {{- $tags = append $tags (printf "uniqueIndex:%s,priority:%d" $idx.Name $prio) -}}
            {{- else -}}
              {{- $tags = append $tags (printf "uniqueIndex:%s" $idx.Name) -}}
            {{- end -}}
          {{- else -}}
            {{- if $isComposite -}}
              {{- $tags = append $tags (printf "uniqueIndex,priority:%d" $prio) -}}
            {{- else -}}
              {{- $tags = append $tags "uniqueIndex" -}}
            {{- end -}}
          {{- end -}}
        {{- else -}}
          {{- if $idx.Name -}}
            {{- if $isComposite -}}
              {{- $tags = append $tags (printf "index:%s,priority:%d" $idx.Name $prio) -}}
            {{- else -}}
              {{- $tags = append $tags (printf "index:%s" $idx.Name) -}}
            {{- end -}}
          {{- else -}}
            {{- if $isComposite -}}
              {{- $tags = append $tags (printf "index,priority:%d" $prio) -}}
            {{- else -}}
              {{- $tags = append $tags "index" -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}


    {{- /* Write semicolon manually to avoid join compatibility issues */ -}}
    {{- $tagstr := "" -}}
    {{- range $i, $t := $tags -}}
      {{- if gt $i 0 -}}{{- $tagstr = printf "%s;%s" $tagstr $t -}}{{- else -}}{{- $tagstr = $t -}}{{- end -}}
    {{- end -}}

    {{- if $tagstr -}}
      {{- printf "\n    %s %s `gorm:\"%s\"`" $field $goType $tagstr -}}
    {{- else -}}
      {{- printf "\n    %s %s" $field $goType -}}
    {{- end -}}
  {{- end }}
}

func ({{ $tableName }}) TableName() string { return "{{ $schema.Name }}.{{ $t.Name }}" }
{{ println }}

{{- if $hasUUIDPK }}
func (m *{{ $tableName }}) BeforeCreate(tx *gorm.DB) (err error) {
	if m.ID == uuid.Nil {
		m.ID, err = uuid.NewV7()
	}
	return
}
{{- end }}

{{ template "ColsStruct" (dict "Table" $t "TableName" $tableName) }}

{{/* ================= PK / UniqueIndex / FK consts ================= */}}
{{- $hasConst := false -}}

{{- $hasPk := and $t.PrimaryKey $t.PrimaryKey.Name -}}
{{- if $hasPk }}
  {{- $hasConst = true -}}
{{- end }}

{{- range $idx := $t.Indexes }}
  {{- if and $idx.Unique $idx.Name }}
    {{- $hasConst = true -}}
  {{- end }}
{{- end }}

{{- range $fk := $t.ForeignKeys }}
  {{- if $fk.Symbol }}
    {{- $hasConst = true -}}
  {{- end }}
{{- end }}

{{- if $hasConst }}
const (
  {{- if $hasPk }}
    {{- printf "\n    %sPk = \"%s\"" $tableName $t.PrimaryKey.Name -}}
  {{- end }}

  {{- range $idx := $t.Indexes }}
    {{- if and $idx.Unique $idx.Name }}
      {{- $suffix := include "IndexSuffix" (dict "name" $idx.Name "table" $t.Name) -}}
      {{- printf "\n    %sUk%s = \"%s\"" $tableName $suffix $idx.Name -}}
    {{- end }}
  {{- end }}

   {{- range $fk := $t.ForeignKeys }}
    {{- if $fk.Symbol }}
      {{- $suffix := include "IndexSuffix" (dict "name" $fk.Symbol "table" $t.Name) -}}
      {{- printf "\n    %sFk%s = \"%s\"" $tableName $suffix $fk.Symbol -}}
    {{- end }}
  {{- end }}
)
{{- end }}
{{- end }}


{{- /* ================== Main: iterate ALL schemas & tables ================== */ -}}
{{- $acc := "" -}}
{{- $root := . -}}
{{- range $schema := $root.Realm.Schemas }}
  {{- range $t := $schema.Tables }}
    {{- $acc = printf "%s%s\n\n" $acc (include "Model" (dict "table" $t "root" $root "schema" $schema)) -}}
  {{- end }}
{{- end }}
{{- $acc | txtar | write "gen/models" -}}

