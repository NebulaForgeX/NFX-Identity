{{- /* ========= Supporting multiple schemas: traverse .Realm.Schemas ========= */ -}}
{{- $txt := "" -}}

{{- range $schema := .Realm.Schemas }}
  {{- /* Collect enums for each schema: bucket -> [{Name, GoType, Values}] */ -}}
  {{- $buckets := dict -}}
  {{- $schemaName := lower $schema.Name -}}

  {{- range $o := $schema.Objects }}
    {{- if eq (printf "%T" $o) "*schema.EnumType" }}
      {{- $enumName := lower $o.T -}}
      {{- $schemaPrefix := (include "Title" $schema.Name) -}}
      {{- $baseType := (include "Title" $o.T) -}}
      {{- $goType := printf "%s%s" $schemaPrefix $baseType -}}
      {{- $bucket   := (include "BucketOf" $o.T) -}}
      {{- if not (hasKey $buckets $bucket) }}
        {{- $_ := set $buckets $bucket (list) -}}
      {{- end }}
      {{- $list := get $buckets $bucket -}}
      {{- $list = append $list (dict "Name" $enumName "GoType" $goType "Values" $o.Values) -}}
      {{- $_ := set $buckets $bucket $list -}}
    {{- end }}
  {{- end }}

  {{- /* Output: one file per bucket, with schema prefix in filename, in gen/enums directory */ -}}
  {{- range $bucket, $enums := $buckets }}
    {{- $file := "" -}}
    {{- $file = printf "%s%s\n\n" $file "// Code generated by gen-enums. DO NOT EDIT." -}}
    {{- $file = printf "%s%s\n\n" $file "package enums" -}}

    {{- range $e := $enums }}
      {{- $goType := get $e "GoType" -}}
      {{- $vals   := get $e "Values" -}}
      {{- $file = printf "%s%s%s%s\n" $file "type " $goType " string" -}}
      {{- $file = printf "%s%s\n" $file "const (" -}}
      {{- range $v := $vals }}
        {{- $Const := (include "Title" $v) -}}
        {{- $file = printf "%s\t%s%s %s = %q\n" $file $goType $Const $goType $v -}}
      {{- end }}
      {{- $file = printf "%s%s\n\n" $file ")" -}}
    {{- end }}

    {{- /* Filename: <schema>__<bucket>.go, to avoid conflicts across schemas with the same bucket */ -}}
    {{- $fname := printf "%s__%s.go" $schemaName (lower $bucket) -}}
    {{- $txt = printf "%s-- %s --\n%s\n" $txt $fname $file -}}
  {{- end }}
{{- end }}

{{- /* Write to the target directory */ -}}
{{- $txt | txtar | write "gen/enums" -}}

