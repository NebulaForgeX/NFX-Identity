---
description: 前端 Events 文件夹编码规范 - 事件系统与缓存失效
globs:
  - '**/src/events/**/*.ts'
alwaysApply: false
---

# Events 编码规范

本规则说明如何组织与编写 **events/** 下的代码，适用于任意采用「事件驱动缓存失效」的前端项目。

## 文件组织

```
events/
├── <module>.ts    # 各业务模块事件（如 auth.ts、user.ts、router.ts）
└── index.ts       # 统一导出（可选）
```

按功能模块划分事件文件，一个领域一个文件。

## 事件定义模式

### 标准结构

```typescript
// events/user.ts
export const userEvents = {
  INVALIDATE_USER: "USER:INVALIDATE_USER",
  INVALIDATE_USERS: "USER:INVALIDATE_USERS",
  ITEM_CREATED: "USER:ITEM_CREATED",
} as const;

type UserEvent = (typeof userEvents)[keyof typeof userEvents];

class UserEventEmitter {
  private listeners: Record<UserEvent, Set<Function>> = {
    [userEvents.INVALIDATE_USER]: new Set<Function>(),
    [userEvents.INVALIDATE_USERS]: new Set<Function>(),
    [userEvents.ITEM_CREATED]: new Set<Function>(),
  };

  on(event: UserEvent, callback: Function) {
    this.listeners[event].add(callback);
  }

  off(event: UserEvent, callback: Function) {
    this.listeners[event].delete(callback);
  }

  emit(event: UserEvent, ...args: unknown[]) {
    this.listeners[event].forEach((cb) => cb(...args));
  }
}

export const userEventEmitter = new UserEventEmitter();
```

### 缓存失效事件命名

- 单条失效：`INVALIDATE_ENTITY`（如 `INVALIDATE_USER`）
- 列表失效：`INVALIDATE_ENTITIES`（如 `INVALIDATE_USERS`）
- 事件名格式：`MODULE:ACTION`，全大写下划线

### 业务 / 路由事件

按需定义，如 `NAVIGATE_TO_EDIT`、`LOGIN_SUCCESS`。可为 EventEmitter 封装便捷方法（如 `navigateToEdit(id)` 内部 emit 对应事件）。

## 命名规范

- 事件常量对象：camelCase + `Events` 后缀，如 `userEvents`、`authEvents`
- 事件类型别名：PascalCase + `Event` 后缀，如 `UserEvent`
- EventEmitter 类：PascalCase + `EventEmitter` 后缀
- 实例：camelCase + `EventEmitter` 后缀，如 `userEventEmitter`
- 文件：kebab-case 或与模块同名的 `<module>.ts`

## 使用方式

### 触发（通常在 hooks 的 mutation onSuccess 中）

```typescript
userEventEmitter.emit(userEvents.INVALIDATE_USERS);
userEventEmitter.emit(userEvents.INVALIDATE_USER, id);
```

### 订阅（通常在 Provider 的 cache invalidation hook 中）

```typescript
useEffect(() => {
  const handler = () => queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USERS });
  userEventEmitter.on(userEvents.INVALIDATE_USERS, handler);
  return () => userEventEmitter.off(userEvents.INVALIDATE_USERS, handler);
}, [queryClient]);
```

## 类型安全

- 事件常量用 `as const`
- 用 `(typeof xxxEvents)[keyof typeof xxxEvents]` 推导事件类型，避免手写字符串

## 实现建议

- 新增模块时：在 `events/<module>.ts` 中补全所有事件键的 `listeners` 初始化，避免运行时缺失
- 缓存失效：Mutation 成功处 emit，专门在 QueryProvider 的 useXxxCacheInvalidation 中订阅并执行 invalidateQueries，保持职责清晰
