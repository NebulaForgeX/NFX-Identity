---
description: Hooks 文件夹编码规范 - 自定义 Hooks
globs:
  - '**/src/hooks/**/*.ts'
  - '**/src/hooks/**/*.tsx'
alwaysApply: false
---

# Hooks 编码规范

## 文件组织

```
hooks/
├── core/                    # 核心工具 hooks（可选）
│   ├── makeUnifiedQuery.tsx          # 统一查询 Hook 工厂
│   ├── makeUnifiedInfiniteQuery.tsx   # 无限查询 Hook 工厂
│   └── ...
├── use<Feature>.ts          # 各功能模块的 Hooks（按需创建）
└── index.ts                # 统一导出
```

**示例**：
- `useAuth.ts` - 认证相关 hooks
- `useUser.ts` - 用户相关 hooks
- `useTheme.ts` - 主题 Context Hook
- 根据项目功能模块创建对应的 Hook 文件

## Hook 分类

### 1. 数据查询 Hooks (CRUD)

使用 `makeUnifiedQuery` 和 `useMutation` 封装 API 调用。

```typescript
// ✅ GOOD - 查询 Hook（使用 makeUnifiedQuery）
import { makeUnifiedQuery } from "@/hooks/core/makeUnifiedQuery";
import { GetUser } from "@/apis/directory.api";
import { DIRECTORY_USER } from "@/constants";
import type { UnifiedQueryParams } from "./core/type";

export const useUser = (params: UnifiedQueryParams<User> & { id: string }) => {
  const { id, options, postProcess } = params;
  const makeQuery = makeUnifiedQuery(
    async (params: { id: string }) => {
      return await GetUser(params.id);
    },
    "suspense",
    postProcess,
  );
  return makeQuery(DIRECTORY_USER(id), { id }, options);
};
```

```typescript
// ✅ GOOD - Mutation Hook（创建）
import { useMutation } from "@tanstack/react-query";
import type { AxiosError } from "axios";
import { CreateUser } from "@/apis/directory.api";
import { directoryEventEmitter, directoryEvents } from "@/events/directory";
import { showError, showSuccess } from "@/stores/modalStore";

export const useCreateUser = () => {
  return useMutation({
    mutationFn: async (params: CreateUserRequest) => {
      return await CreateUser(params);
    },
    onSuccess: () => {
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USERS);
      showSuccess("用户创建成功！");
    },
    onError: (error: AxiosError) => {
      showError("创建用户失败，请稍后重试。" + error.message);
    },
  });
};
```

```typescript
// ✅ GOOD - Mutation Hook（更新）
export const useUpdateUser = () => {
  return useMutation({
    mutationFn: async (params: { id: string; data: UpdateUserRequest }) => {
      return await UpdateUser(params.id, params.data);
    },
    onSuccess: (_, variables) => {
      // 失效列表和单项缓存
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USERS);
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USER, variables.id);
      showSuccess("用户更新成功！");
    },
    onError: (error: AxiosError) => {
      showError("更新用户失败，请稍后重试。" + error.message);
    },
  });
};
```

```typescript
// ✅ GOOD - Mutation Hook（删除）
export const useDeleteUser = () => {
  return useMutation({
    mutationFn: async (id: string) => {
      return await DeleteUser(id);
    },
    onSuccess: (_, id) => {
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USERS);
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USER, id);
      showSuccess("用户删除成功！");
    },
    onError: (error: AxiosError) => {
      showError("删除用户失败，请稍后重试。" + error.message);
    },
  });
};
```

### 2. Context Hooks

简单的 Context 包装，提供类型安全和错误检查。

```typescript
// ✅ GOOD - Context Hook
import { useContext } from "react";
import { ThemeContext } from "@/providers/ThemeProvider";

export const useTheme = () => {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error("useTheme must be used within a ThemeProvider");
  }
  return context;
};
```

### 3. 工具 Hooks

封装通用逻辑，如计时器、状态管理等。

```typescript
// ✅ GOOD - 计时器 Hook
import { useCallback, useEffect, useState } from "react";
import TimerStore, { useTimerStore } from "@/stores/timerStore";

export const useResendTimer = () => {
  const canResendFromStore = useTimerStore((state) => state.canResendCode());
  const getTimeLeft = useTimerStore((state) => state.getTimeLeft);

  const [timeLeft, setTimeLeft] = useState(getTimeLeft());
  const [canResend, setCanResend] = useState(canResendFromStore);

  useEffect(() => {
    const interval = setInterval(() => {
      const remaining = getTimeLeft();
      setTimeLeft(remaining);
      setCanResend(remaining === 0);
    }, 1000);

    return () => clearInterval(interval);
  }, [getTimeLeft]);

  const startTimer = useCallback((seconds: number = 60) => {
    const expiry = Date.now() + seconds * 1000;
    TimerStore.getState().setResendCodeExpiry(expiry);
    setTimeLeft(seconds);
    setCanResend(false);
  }, []);

  return {
    timeLeft,
    canResend,
    startTimer,
  };
};
```

### 4. 样式 Hooks

返回状态样式信息（颜色、标签等），用于 UI 显示。

```typescript
// ✅ GOOD - 状态样式 Hook
import { useTranslation } from "react-i18next";
import { UserStatus } from "@/types/domain/enums";

export interface StatusStyle {
  label: string;
  color: string;
  bgColor: string;
}

export const useUserStatus = (status: UserStatus | undefined | null): StatusStyle => {
  const { t } = useTranslation("hooks.styles");

  const statusMap: Record<UserStatus, StatusStyle> = {
    [UserStatus.ACTIVE]: {
      label: t("userStatus.active"),
      color: "var(--color-primary-fg)",
      bgColor: "var(--color-success)",
    },
    [UserStatus.PENDING]: {
      label: t("userStatus.pending"),
      color: "white",
      bgColor: "var(--color-warning)",
    },
    // ...
  };

  if (!status) {
    return {
      label: "",
      color: "white",
      bgColor: "var(--color-fg-muted)",
    };
  }

  return statusMap[status] || {
    label: status,
    color: "white",
    bgColor: "var(--color-fg-muted)",
  };
};
```

### 5. 同步 Hooks

同步用户偏好到后端，只在初始加载时应用后端数据。

```typescript
// ✅ GOOD - 偏好同步 Hook
import { useEffect, useCallback, useRef } from "react";
import { useAuthStore } from "@/stores/authStore";
import { useUpdateUserPreference, useUserPreferenceNormal } from "@/hooks/useDirectory";
import { useTheme } from "@/hooks/useTheme";

export const useThemeSync = () => {
  const currentUserId = useAuthStore((state) => state.currentUserId);
  const isAuthValid = useAuthStore((state) => state.isAuthValid);
  const { themeName, setTheme } = useTheme();
  const updatePreference = useUpdateUserPreference({ silent: true });

  const shouldFetch = !!currentUserId && isAuthValid;

  const { data: preference } = useUserPreferenceNormal({
    id: currentUserId || "00000000-0000-0000-0000-000000000000",
    options: {
      enabled: shouldFetch && !!currentUserId,
    },
  });

  const lastPreferenceId = useRef<string | null>(null);
  const isInitialized = useRef(false);

  // 只在初始加载时应用后端数据
  useEffect(() => {
    if (!shouldFetch || !preference || !isAuthValid || !currentUserId) {
      isInitialized.current = false;
      lastPreferenceId.current = null;
      return;
    }

    // 只在 preference ID 变化或首次加载时应用
    if (lastPreferenceId.current === preference.id && isInitialized.current) {
      return;
    }

    if (preference.theme && preference.theme !== themeName) {
      setTheme(preference.theme as any);
    }

    isInitialized.current = true;
    lastPreferenceId.current = preference.id;
  }, [preference, isAuthValid, currentUserId, themeName, setTheme, shouldFetch]);

  // 同步本地变更到后端
  const syncTheme = useCallback(
    async (theme: string) => {
      if (!currentUserId || !isAuthValid) return;

      try {
        await updatePreference.mutateAsync({
          id: currentUserId,
          data: { theme },
        });
      } catch (error) {
        console.error("Failed to sync theme preference:", error);
      }
    },
    [currentUserId, isAuthValid, updatePreference]
  );

  return { syncTheme };
};
```

## 核心工具 Hooks

### makeUnifiedQuery

创建统一的查询 Hook，支持 Suspense 和普通模式。

```typescript
// ✅ GOOD - 使用 makeUnifiedQuery
import { makeUnifiedQuery } from "@/hooks/core/makeUnifiedQuery";

// Suspense 模式（默认）
const makeQuery = makeUnifiedQuery(
  async (params: { id: string }) => {
    return await GetUser(params.id);
  },
  "suspense",
  postProcess, // 可选的后处理函数
);

// 普通模式（支持 enabled）
const makeQuery = makeUnifiedQuery(
  async (params: { id: string }) => {
    return await GetUser(params.id);
  },
  "normal",
  postProcess,
);
```

### makeUnifiedInfiniteQuery

创建无限查询 Hook，支持分页加载。

```typescript
// ✅ GOOD - 使用 makeUnifiedInfiniteQuery
import { makeUnifiedInfiniteQuery } from "@/hooks/core/makeUnifiedInfiniteQuery";

const useUserList = makeUnifiedInfiniteQuery(
  async (params: FetchNumberListParams<UserFilter>) => {
    const { items, total } = await GetUsers(params);
    return { items, total };
  },
  "suspense",
  20, // pageSize
  postProcess, // 可选的后处理函数
);

// 使用
const { data, fetchNextPage, hasNextPage } = useUserList(
  DIRECTORY_USERS,
  { status: "active" },
  { staleTime: 60000 }
);
```

## 命名规范

- **Hook 文件**: camelCase，以 `use` 开头: `useAuth.ts`, `useDirectory.ts`
- **Hook 函数**: camelCase，以 `use` 开头: `useAuth`, `useCreateUser`
- **查询 Hook**: `useEntity` 或 `useEntityByXxx` (如 `useUser`, `useUserByUsername`)
- **Mutation Hook**: `useCreateEntity`, `useUpdateEntity`, `useDeleteEntity`
- **列表查询 Hook**: `useEntitiesByXxx` (如 `useUserEmailsByUserID`)
- **核心工具**: `makeXxx` (如 `makeUnifiedQuery`, `makeUnifiedInfiniteQuery`)

## 事件和缓存失效

```typescript
// ✅ GOOD - Mutation 成功后触发事件失效缓存
onSuccess: (_, variables) => {
  // 失效列表缓存
  directoryEventEmitter.emit(directoryEvents.INVALIDATE_USERS);
  // 失效单项缓存
  directoryEventEmitter.emit(directoryEvents.INVALIDATE_USER, variables.id);
  showSuccess("用户更新成功！");
},
```

## 错误处理

```typescript
// ✅ GOOD - 统一的错误处理
onError: (error: AxiosError) => {
  const errorMessage = (error.response?.data as { message?: string })?.message;
  if (errorMessage?.includes("locked")) {
    showError("账户已被锁定，请联系管理员");
  } else if (errorMessage?.includes("invalid")) {
    showError("邮箱或密码错误");
  } else {
    showError("操作失败，请稍后重试");
  }
},
```

## 静默更新

```typescript
// ✅ GOOD - 支持静默更新（不显示成功/错误消息）
export const useUpdateUserPreference = (options?: { silent?: boolean }) => {
  const silent = options?.silent ?? false;
  return useMutation({
    mutationFn: async (params: { id: string; data: UpdateUserPreferenceRequest }) => {
      return await UpdateUserPreference(params.id, params.data);
    },
    onSuccess: (_, variables) => {
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USER_PREFERENCES);
      directoryEventEmitter.emit(directoryEvents.INVALIDATE_USER_PREFERENCE, variables.id);
      if (!silent) {
        showSuccess("用户偏好更新成功！");
      }
    },
    onError: (error: AxiosError) => {
      if (!silent) {
        showError("更新用户偏好失败，请稍后重试。" + error.message);
      }
    },
  });
};
```

## 类型定义

```typescript
// ✅ GOOD - UnifiedQueryParams 类型
import type { UnifiedQueryParams } from "./core/type";

export const useUser = (params: UnifiedQueryParams<User> & { id: string }) => {
  const { id, options, postProcess } = params;
  // ...
};
```

## 实现建议

- 按功能分类组织 Hooks，使用 `use<Feature>` 命名
- 核心工具函数放在 `core/` 目录下
- 保持文件命名一致性：`use<功能名>.ts`
- 所有 Hooks 通过 `index.ts` 统一导出，方便使用
