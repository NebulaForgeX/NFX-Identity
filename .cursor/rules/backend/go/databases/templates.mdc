---
description: Templates 编码规范 - 代码生成模板
globs:
  - '**/databases/templates/**/*.tmpl'
alwaysApply: false
---

# Templates 编码规范

## 文件组织

```
databases/templates/
├── _helpers.tmpl         # 模板辅助函数
├── gen_models.tmpl       # 模型生成模板
├── gen_views.tmpl        # 视图生成模板
└── gen_enums.tmpl        # 枚举生成模板
```

## 模板结构

### 辅助函数模板（_helpers.tmpl）

```go
{{- /* ✅ GOOD - 模板辅助函数定义 */ -}}
{{- define "Title" -}}
  {{- /* 转换为 PascalCase */ -}}
{{- end -}}

{{- define "Singular" -}}
  {{- /* 转换为单数形式 */ -}}
{{- end -}}

{{- define "FieldName" -}}
  {{- /* 转换为 Go 字段名 */ -}}
{{- end -}}

{{- define "ResolveType" -}}
  {{- /* 解析数据库类型为 Go 类型 */ -}}
{{- end -}}
```

### 枚举生成模板（gen_enums.tmpl）

```go
{{- /* ✅ GOOD - 枚举生成模板 */ -}}
{{- range $schema := .Realm.Schemas }}
  {{- /* 收集每个 schema 的枚举 */ -}}
  {{- $buckets := dict -}}
  {{- range $o := $schema.Objects }}
    {{- if eq (printf "%T" $o) "*schema.EnumType" }}
      {{- /* 处理枚举类型 */ -}}
    {{- end }}
  {{- end }}
  
  {{- /* 输出：每个 bucket 一个文件 */ -}}
  {{- range $bucket, $enums := $buckets }}
    {{- /* 生成枚举代码 */ -}}
    {{- $file = printf "%s%s\n\n" $file "// Code generated by gen-enums. DO NOT EDIT." -}}
    {{- $file = printf "%s%s\n\n" $file "package enums" -}}
    {{- /* ... 枚举定义 ... */ -}}
  {{- end }}
{{- end }}
```

### 模型生成模板（gen_models.tmpl）

```go
{{- /* ✅ GOOD - 模型生成模板 */ -}}
{{- define "Model" }}
  {{- /* 遍历所有表 */ -}}
  {{- range $schema := .Realm.Schemas }}
    {{- range $table := $schema.Tables }}
      {{- /* 生成 GORM 模型 */ -}}
      {{- $tableName := exec "Title" $table.Name | exec "Singular" -}}
      {{- /* ... 字段定义 ... */ -}}
    {{- end }}
  {{- end }}
{{- end }}
```

## 命名规范

- **模板文件**：使用 `snake_case`，以 `.tmpl` 结尾: `gen_models.tmpl`
- **辅助函数**：使用 `PascalCase`: `Title`, `Singular`, `FieldName`
- **生成的文件**：由模板决定，通常使用 `snake_case` 或 `PascalCase`

## 实现建议

- **辅助函数**：通用辅助函数放在 `_helpers.tmpl` 中
- **代码生成标记**：生成的代码文件头部标注 `// Code generated by <tool>. DO NOT EDIT.`
- **多 Schema 支持**：模板应该支持多个 Schema，使用 schema 前缀避免冲突
- **类型映射**：正确映射数据库类型到 Go 类型（UUID, TIMESTAMP, ENUM 等）
- **特殊字段处理**：正确处理 `deleted_at`（软删除）、`created_at`、`updated_at` 等特殊字段
