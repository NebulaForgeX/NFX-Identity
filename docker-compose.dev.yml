name: nfx-id-dev

services:
  #! Traefik Reverse Proxy
  reverse-proxy:
    image: traefik:latest
    container_name: NFX-Identity-Reverse-Proxy-Dev
    command:
      - --api.insecure=true
      - --providers.docker
      - --providers.docker.exposedByDefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.traefik.address=:8080
    ports:
      - "10187:80"   # web entry
      - "10189:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - nfx-identity
    restart: unless-stopped

  #! Auth API Service
  auth-api:
    image: nfx-identity-auth-api:dev
    container_name: NFX-Identity-Auth-API-Dev
    build:
      context: .
      dockerfile: inputs/auth/api/Dockerfile
      target: dev
    environment:
      - ENV=dev
    command: [ "air", "-c", "inputs/auth/api/.air.toml" ]
    expose:
      - "8080"
    labels:
      traefik.enable: "true"
      traefik.http.routers.auth-api.entrypoints: web
      traefik.http.routers.auth-api.rule: PathPrefix(`/auth`)
      traefik.http.services.auth-api.loadbalancer.server.port: "8080"
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    develop:
      watch:
        - action: sync
          path: inputs/auth/api
          target: /app/inputs/auth/api
        - action: sync
          path: inputs/auth/config
          target: /app/inputs/auth/config
        - action: sync
          path: modules/auth
          target: /app/modules/auth
        - action: sync
          path: modules/image
          target: /app/modules/image
        - action: sync
          path: models
          target: /app/models
        - action: sync
          path: enums
          target: /app/enums
        - action: sync
          path: events
          target: /app/events
        - action: sync
          path: pkgs
          target: /app/pkgs
        - action: sync
          path: protos
          target: /app/protos
        - action: sync
          path: go.mod
          target: /app/go.mod
        - action: sync
          path: go.sum
          target: /app/go.sum
        - action: rebuild
          path: inputs/auth/api/Dockerfile
    depends_on:
      reverse-proxy:
        condition: service_started
    networks:
      - nfx-identity

  #! Image API Service
  image-api:
    image: nfx-identity-image-api:dev
    container_name: NFX-Identity-Image-API-Dev
    build:
      context: .
      dockerfile: inputs/image/api/Dockerfile
      target: dev
    environment:
      - ENV=dev
    command: [ "air", "-c", "inputs/image/api/.air.toml" ]
    expose:
      - "8080"
    labels:
      traefik.enable: "true"
      traefik.http.routers.image-api.entrypoints: web
      traefik.http.routers.image-api.rule: PathPrefix(`/image`)
      traefik.http.services.image-api.loadbalancer.server.port: "8080"
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    develop:
      watch:
        - action: sync
          path: inputs/image/api
          target: /app/inputs/image/api
        - action: sync
          path: inputs/image/config
          target: /app/inputs/image/config
        - action: sync
          path: modules/image
          target: /app/modules/image
        - action: sync
          path: models
          target: /app/models
        - action: sync
          path: enums
          target: /app/enums
        - action: sync
          path: events
          target: /app/events
        - action: sync
          path: pkgs
          target: /app/pkgs
        - action: sync
          path: protos
          target: /app/protos
        - action: sync
          path: go.mod
          target: /app/go.mod
        - action: sync
          path: go.sum
          target: /app/go.sum
        - action: rebuild
          path: inputs/image/api/Dockerfile
    depends_on:
      reverse-proxy:
        condition: service_started
    networks:
      - nfx-identity

  #! Permission API Service
  permission-api:
    image: nfx-identity-permission-api:dev
    container_name: NFX-Identity-Permission-API-Dev
    build:
      context: .
      dockerfile: inputs/permission/api/Dockerfile
      target: dev
    environment:
      - ENV=dev
    command: [ "air", "-c", "inputs/permission/api/.air.toml" ]
    expose:
      - "8081"
    labels:
      traefik.enable: "true"
      traefik.http.routers.permission-api.entrypoints: web
      traefik.http.routers.permission-api.rule: PathPrefix(`/permission`)
      traefik.http.services.permission-api.loadbalancer.server.port: "8081"
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    develop:
      watch:
        - action: sync
          path: inputs/permission/api
          target: /app/inputs/permission/api
        - action: sync
          path: inputs/permission/config
          target: /app/inputs/permission/config
        - action: sync
          path: modules/permission
          target: /app/modules/permission
        - action: sync
          path: modules/auth
          target: /app/modules/auth
        - action: sync
          path: models
          target: /app/models
        - action: sync
          path: enums
          target: /app/enums
        - action: sync
          path: events
          target: /app/events
        - action: sync
          path: pkgs
          target: /app/pkgs
        - action: sync
          path: protos
          target: /app/protos
        - action: sync
          path: go.mod
          target: /app/go.mod
        - action: sync
          path: go.sum
          target: /app/go.sum
        - action: rebuild
          path: inputs/permission/api/Dockerfile
    depends_on:
      reverse-proxy:
        condition: service_started
    networks:
      - nfx-identity

  #! Console Service (Control Panel Frontend) - Dev mode uses base (all-in-one)
  console:
    image: nfx-identity-console-base:dev
    container_name: NFX-Identity-Console-Dev
    build:
      context: .
      dockerfile: inputs/console/base/Dockerfile
      target: dev
    environment:
      - ENV=dev
    command: [ "air", "-c", "inputs/console/base/.air.toml" ]
    expose:
      - "8080"
    labels:
      traefik.enable: "true"
      traefik.http.routers.console.entrypoints: web
      traefik.http.routers.console.rule: PathPrefix(`/`)
      traefik.http.routers.console.priority: "1"  # 高优先级，确保根路径匹配
      traefik.http.services.console.loadbalancer.server.port: "8080"
    volumes:
      - ./console/dist:/app/console/dist
    develop:
      watch:
        - action: sync
          path: inputs/console
          target: /app/inputs/console
        - action: sync
          path: modules/console
          target: /app/modules/console
        - action: sync
          path: pkgs
          target: /app/pkgs
        - action: sync
          path: go.mod
          target: /app/go.mod
        - action: sync
          path: go.sum
          target: /app/go.sum
        - action: sync
          path: console/dist
          target: /app/console/dist
        - action: rebuild
          path: inputs/console/base/Dockerfile
    depends_on:
      reverse-proxy:
        condition: service_started
    networks:
      - nfx-identity

networks:
  nfx-identity:
    name: nfx-identity
    driver: bridge
