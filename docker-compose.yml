name: nfx-id

services:
  #! Traefik Reverse Proxy
  reverse-proxy:
    image: traefik:v3.4
    container_name: NFX-Identity-Reverse-Proxy-Prod
    restart: always
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker
      - --providers.docker.exposedByDefault=false
      # HTTP 和 HTTPS 入口
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # HTTP → HTTPS 重定向（外网）
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      # Let's Encrypt 自动证书
      - --certificatesresolvers.letsencrypt.acme.email=lyuchongkai@gmail.com
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "10187:80"   # 内网 HTTP 入口
      - "10188:443"  # 外网 HTTPS 入口
      - "10189:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs:/letsencrypt
    networks:
      - nfx-identity

  #! Auth API Service
  auth-api:
    image: nfx-identity-auth-api:prod
    container_name: NFX-Identity-Auth-API-Prod
    build:
      context: .
      dockerfile: inputs/auth/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.auth-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.auth-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/auth`)"
      - "traefik.http.routers.auth-api-secure.entrypoints=websecure"
      - "traefik.http.routers.auth-api-secure.service=auth-api"
      - "traefik.http.routers.auth-api-secure.tls=true"
      - "traefik.http.routers.auth-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由（通过端口访问，允许任何 Host）
      - "traefik.http.routers.auth-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/auth`)"
      - "traefik.http.routers.auth-api-insecure.entrypoints=web"
      - "traefik.http.routers.auth-api-insecure.service=auth-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Auth Pipeline Service（kafka）
  auth-pipeline:
    image: nfx-identity-auth-pipeline:prod
    container_name: NFX-Identity-Auth-Pipeline-Prod 
    build:
      context: .
      dockerfile: inputs/auth/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - auth-api

  #! Auth Connection Service (gRPC)
  auth-connection:
    image: nfx-identity-auth-connection:prod
    container_name: NFX-Identity-Auth-Connection-Prod
    build:
      context: .
      dockerfile: inputs/auth/connection/Dockerfile
    restart: always
    expose:
      - "10012"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10012:10012"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - auth-api

  #! Image API Service
  image-api:
    image: nfx-identity-image-api:prod
    container_name: NFX-Identity-Image-API-Prod
    build:
      context: .
      dockerfile: inputs/image/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.image-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.image-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/image`)"
      - "traefik.http.routers.image-api-secure.entrypoints=websecure"
      - "traefik.http.routers.image-api-secure.service=image-api"
      - "traefik.http.routers.image-api-secure.tls=true"
      - "traefik.http.routers.image-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.image-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/image`)"
      - "traefik.http.routers.image-api-insecure.entrypoints=web"
      - "traefik.http.routers.image-api-insecure.service=image-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Image Pipeline Service
  image-pipeline:
    image: nfx-identity-image-pipeline:prod
    container_name: NFX-Identity-Image-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/image/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - image-api

  #! Image Connection Service (gRPC)
  image-connection:
    image: nfx-identity-image-connection:prod
    container_name: NFX-Identity-Image-Connection-Prod
    build:
      context: .
      dockerfile: inputs/image/connection/Dockerfile
    restart: always
    expose:
      - "10013"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10013:10013"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - image-api

  #! Auth Messaging Service
  auth-messaging:
    image: nfx-identity-auth-messaging:prod
    container_name: NFX-Identity-Auth-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/auth/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - auth-api

  #! Image Messaging Service
  image-messaging:
    image: nfx-identity-image-messaging:prod
    container_name: NFX-Identity-Image-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/image/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - image-api

  #! Access API Service
  access-api:
    image: nfx-identity-access-api:prod
    container_name: NFX-Identity-Access-API-Prod
    build:
      context: .
      dockerfile: inputs/access/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.access-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.access-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/access`)"
      - "traefik.http.routers.access-api-secure.entrypoints=websecure"
      - "traefik.http.routers.access-api-secure.service=access-api"
      - "traefik.http.routers.access-api-secure.tls=true"
      - "traefik.http.routers.access-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.access-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/access`)"
      - "traefik.http.routers.access-api-insecure.entrypoints=web"
      - "traefik.http.routers.access-api-insecure.service=access-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Access Pipeline Service
  access-pipeline:
    image: nfx-identity-access-pipeline:prod
    container_name: NFX-Identity-Access-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/access/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - access-api

  #! Access Connection Service (gRPC)
  access-connection:
    image: nfx-identity-access-connection:prod
    container_name: NFX-Identity-Access-Connection-Prod
    build:
      context: .
      dockerfile: inputs/access/connection/Dockerfile
    restart: always
    expose:
      - "10015"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10015:10015"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - access-api

  #! Access Messaging Service
  access-messaging:
    image: nfx-identity-access-messaging:prod
    container_name: NFX-Identity-Access-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/access/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - access-api

  #! Audit API Service
  audit-api:
    image: nfx-identity-audit-api:prod
    container_name: NFX-Identity-Audit-API-Prod
    build:
      context: .
      dockerfile: inputs/audit/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.audit-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.audit-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/audit`)"
      - "traefik.http.routers.audit-api-secure.entrypoints=websecure"
      - "traefik.http.routers.audit-api-secure.service=audit-api"
      - "traefik.http.routers.audit-api-secure.tls=true"
      - "traefik.http.routers.audit-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.audit-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/audit`)"
      - "traefik.http.routers.audit-api-insecure.entrypoints=web"
      - "traefik.http.routers.audit-api-insecure.service=audit-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Audit Pipeline Service
  audit-pipeline:
    image: nfx-identity-audit-pipeline:prod
    container_name: NFX-Identity-Audit-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/audit/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - audit-api

  #! Audit Connection Service (gRPC)
  audit-connection:
    image: nfx-identity-audit-connection:prod
    container_name: NFX-Identity-Audit-Connection-Prod
    build:
      context: .
      dockerfile: inputs/audit/connection/Dockerfile
    restart: always
    expose:
      - "10016"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10016:10016"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - audit-api

  #! Audit Messaging Service
  audit-messaging:
    image: nfx-identity-audit-messaging:prod
    container_name: NFX-Identity-Audit-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/audit/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - audit-api

  #! Clients API Service
  clients-api:
    image: nfx-identity-clients-api:prod
    container_name: NFX-Identity-Clients-API-Prod
    build:
      context: .
      dockerfile: inputs/clients/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.clients-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.clients-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/clients`)"
      - "traefik.http.routers.clients-api-secure.entrypoints=websecure"
      - "traefik.http.routers.clients-api-secure.service=clients-api"
      - "traefik.http.routers.clients-api-secure.tls=true"
      - "traefik.http.routers.clients-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.clients-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/clients`)"
      - "traefik.http.routers.clients-api-insecure.entrypoints=web"
      - "traefik.http.routers.clients-api-insecure.service=clients-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Clients Pipeline Service
  clients-pipeline:
    image: nfx-identity-clients-pipeline:prod
    container_name: NFX-Identity-Clients-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/clients/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - clients-api

  #! Clients Connection Service (gRPC)
  clients-connection:
    image: nfx-identity-clients-connection:prod
    container_name: NFX-Identity-Clients-Connection-Prod
    build:
      context: .
      dockerfile: inputs/clients/connection/Dockerfile
    restart: always
    expose:
      - "10017"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10017:10017"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - clients-api

  #! Clients Messaging Service
  clients-messaging:
    image: nfx-identity-clients-messaging:prod
    container_name: NFX-Identity-Clients-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/clients/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - clients-api

  #! Directory API Service
  directory-api:
    image: nfx-identity-directory-api:prod
    container_name: NFX-Identity-Directory-API-Prod
    build:
      context: .
      dockerfile: inputs/directory/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.directory-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.directory-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/directory`)"
      - "traefik.http.routers.directory-api-secure.entrypoints=websecure"
      - "traefik.http.routers.directory-api-secure.service=directory-api"
      - "traefik.http.routers.directory-api-secure.tls=true"
      - "traefik.http.routers.directory-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.directory-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/directory`)"
      - "traefik.http.routers.directory-api-insecure.entrypoints=web"
      - "traefik.http.routers.directory-api-insecure.service=directory-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Directory Pipeline Service
  directory-pipeline:
    image: nfx-identity-directory-pipeline:prod
    container_name: NFX-Identity-Directory-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/directory/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - directory-api

  #! Directory Connection Service (gRPC)
  directory-connection:
    image: nfx-identity-directory-connection:prod
    container_name: NFX-Identity-Directory-Connection-Prod
    build:
      context: .
      dockerfile: inputs/directory/connection/Dockerfile
    restart: always
    expose:
      - "10018"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10018:10018"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - directory-api

  #! Directory Messaging Service
  directory-messaging:
    image: nfx-identity-directory-messaging:prod
    container_name: NFX-Identity-Directory-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/directory/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - directory-api

  #! System API Service
  system-api:
    image: nfx-identity-system-api:prod
    container_name: NFX-Identity-System-API-Prod
    build:
      context: .
      dockerfile: inputs/system/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.system-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.system-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/system`)"
      - "traefik.http.routers.system-api-secure.entrypoints=websecure"
      - "traefik.http.routers.system-api-secure.service=system-api"
      - "traefik.http.routers.system-api-secure.tls=true"
      - "traefik.http.routers.system-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.system-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/system`)"
      - "traefik.http.routers.system-api-insecure.entrypoints=web"
      - "traefik.http.routers.system-api-insecure.service=system-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! System Pipeline Service
  system-pipeline:
    image: nfx-identity-system-pipeline:prod
    container_name: NFX-Identity-System-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/system/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - system-api

  #! System Connection Service (gRPC)
  system-connection:
    image: nfx-identity-system-connection:prod
    container_name: NFX-Identity-System-Connection-Prod
    build:
      context: .
      dockerfile: inputs/system/connection/Dockerfile
    restart: always
    expose:
      - "10019"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10019:10019"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - system-api

  #! System Messaging Service
  system-messaging:
    image: nfx-identity-system-messaging:prod
    container_name: NFX-Identity-System-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/system/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - system-api

  #! Tenants API Service
  tenants-api:
    image: nfx-identity-tenants-api:prod
    container_name: NFX-Identity-Tenants-API-Prod
    build:
      context: .
      dockerfile: inputs/tenants/api/Dockerfile
    restart: always
    expose:
      - "8080"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.tenants-api.loadbalancer.server.port=8080"
      # 外网 HTTPS 路由
      - "traefik.http.routers.tenants-api-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/tenants`)"
      - "traefik.http.routers.tenants-api-secure.entrypoints=websecure"
      - "traefik.http.routers.tenants-api-secure.service=tenants-api"
      - "traefik.http.routers.tenants-api-secure.tls=true"
      - "traefik.http.routers.tenants-api-secure.tls.certresolver=letsencrypt"
      # 内网 HTTP 路由
      - "traefik.http.routers.tenants-api-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/tenants`)"
      - "traefik.http.routers.tenants-api-insecure.entrypoints=web"
      - "traefik.http.routers.tenants-api-insecure.service=tenants-api"
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity

  #! Tenants Pipeline Service
  tenants-pipeline:
    image: nfx-identity-tenants-pipeline:prod
    container_name: NFX-Identity-Tenants-Pipeline-Prod
    build:
      context: .
      dockerfile: inputs/tenants/pipeline/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - tenants-api

  #! Tenants Connection Service (gRPC)
  tenants-connection:
    image: nfx-identity-tenants-connection:prod
    container_name: NFX-Identity-Tenants-Connection-Prod
    build:
      context: .
      dockerfile: inputs/tenants/connection/Dockerfile
    restart: always
    expose:
      - "10020"  # gRPC 端口（与 prod.toml 中的 grpc_port 一致）
    # ports:
    #   - "10020:10020"  # 可选：如果需要从宿主机访问，取消注释
    environment:
      - ENV=prod
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - tenants-api

  #! Tenants Messaging Service
  tenants-messaging:
    image: nfx-identity-tenants-messaging:prod
    container_name: NFX-Identity-Tenants-Messaging-Prod
    build:
      context: .
      dockerfile: inputs/tenants/messaging/Dockerfile
    restart: always
    environment:
      - ENV=prod
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./static:/app/static
      - ./data:/app/data
      - ./assets:/app/assets
    networks:
      - nfx-identity
    depends_on:
      - tenants-api

  #! Console Service (Control Panel Frontend) - Prod mode uses api (HTTP only)
  console:
    image: nfx-identity-console-api:prod
    container_name: NFX-Identity-Console-Prod
    build:
      context: .
      dockerfile: inputs/console/api/Dockerfile
    restart: always
    expose:
      - "80"
    labels:
      - "traefik.enable=true"
      # 服务定义
      - "traefik.http.services.console.loadbalancer.server.port=80"
      # 外网 HTTPS 路由 - 控制面板根路径
      - "traefik.http.routers.console-secure.rule=Host(`auth.lucaslyu.com`) && PathPrefix(`/`)"
      - "traefik.http.routers.console-secure.entrypoints=websecure"
      - "traefik.http.routers.console-secure.service=console"
      - "traefik.http.routers.console-secure.tls=true"
      - "traefik.http.routers.console-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.console-secure.priority=1"  # 高优先级，确保根路径匹配
      # 内网 HTTP 路由
      - "traefik.http.routers.console-insecure.rule=HostRegexp(`.*`) && PathPrefix(`/`)"
      - "traefik.http.routers.console-insecure.entrypoints=web"
      - "traefik.http.routers.console-insecure.service=console"
      - "traefik.http.routers.console-insecure.priority=1"  # 高优先级
    environment:
      - ENV=prod
    depends_on:
      - reverse-proxy
    networks:
      - nfx-identity


networks:
  nfx-identity:
    name: nfx-identity
    driver: bridge


