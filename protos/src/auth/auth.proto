syntax = "proto3";
package auth;

option go_package = "nfxid/protos/gen/auth/auth;authpb";

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "auth/user.proto";
import "auth/role.proto";
import "auth/profile.proto";

// 认证状态
enum AuthStatus {
  AUTH_STATUS_UNSPECIFIED = 0; // 未指定状态
  AUTH_STATUS_PENDING = 1; // 待激活
  AUTH_STATUS_ACTIVE = 2; // 正常
  AUTH_STATUS_DEACTIVE = 3; // 停用
}

// Auth 服务 - 供其他服务通过 gRPC 读取认证信息
service AuthService {
  // 根据用户ID获取认证信息（包含用户、角色和资料信息）
  rpc GetAuthByUserID (GetAuthByUserIDRequest) returns (GetAuthByUserIDResponse);
  
  // 根据用户名获取认证信息
  rpc GetAuthByUsername (GetAuthByUsernameRequest) returns (GetAuthByUsernameResponse);
  
  // 根据邮箱获取认证信息
  rpc GetAuthByEmail (GetAuthByEmailRequest) returns (GetAuthByEmailResponse);
  
  // 根据手机号获取认证信息
  rpc GetAuthByPhone (GetAuthByPhoneRequest) returns (GetAuthByPhoneResponse);
  
  // 批量获取认证信息（包含用户、角色和资料信息）
  rpc BatchGetAuth (BatchGetAuthRequest) returns (BatchGetAuthResponse);
  
  // 验证密码
  rpc VerifyPassword (VerifyPasswordRequest) returns (VerifyPasswordResponse);
  
  // 验证用户是否存在
  rpc VerifyUserExists (VerifyUserExistsRequest) returns (VerifyUserExistsResponse);
  
  // 发送验证码（发送邮件，存储到 Redis）
  rpc SendVerificationCode (SendVerificationCodeRequest) returns (SendVerificationCodeResponse);
  
  // 检查用户是否存在并验证验证码（用于注册流程）
  rpc CheckUserAndVerificationCode (CheckUserAndVerificationCodeRequest) returns (CheckUserAndVerificationCodeResponse);
  
  // 创建用户和 Profile（用于注册流程）
  rpc CreateUserWithProfile (CreateUserWithProfileRequest) returns (CreateUserWithProfileResponse);
}

// 根据用户ID获取认证信息
message GetAuthByUserIDRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  optional bool include_roles = 2; // 是否包含角色信息（多对多关系）
  optional bool include_profile = 3; // 是否包含资料信息
}

message GetAuthByUserIDResponse {
  Auth auth = 1;
}

// 根据用户名获取认证信息
message GetAuthByUsernameRequest {
  string username = 1 [(buf.validate.field).string.min_len = 1, (buf.validate.field).string.max_len = 50];
  optional bool include_role = 2;
  optional bool include_profile = 3;
}

message GetAuthByUsernameResponse {
  Auth auth = 1;
}

// 根据邮箱获取认证信息
message GetAuthByEmailRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  optional bool include_role = 2;
  optional bool include_profile = 3;
}

message GetAuthByEmailResponse {
  Auth auth = 1;
}

// 根据手机号获取认证信息
message GetAuthByPhoneRequest {
  string phone = 1 [(buf.validate.field).string.min_len = 1, (buf.validate.field).string.max_len = 20];
  optional bool include_role = 2;
  optional bool include_profile = 3;
}

message GetAuthByPhoneResponse {
  Auth auth = 1;
}

// 批量获取认证信息
message BatchGetAuthRequest {
  repeated string user_ids = 1 [(buf.validate.field).repeated = {min_items: 1, max_items: 100}];
  optional bool include_role = 2;
  optional bool include_profile = 3;
}

message BatchGetAuthResponse {
  repeated Auth auths = 1;
  map<string, string> error_by_id = 2; // user_id -> error_message
}

// 验证密码
message VerifyPasswordRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string password = 2 [(buf.validate.field).string.min_len = 1];
}

message VerifyPasswordResponse {
  bool valid = 1;
  optional string error_message = 2;
}

// 验证用户是否存在
message VerifyUserExistsRequest {
  optional string username = 1;
  optional string email = 2;
  optional string phone = 3;
}

message VerifyUserExistsResponse {
  bool exists = 1;
  string field = 2; // "username", "email", "phone" 或空字符串
}

// 发送验证码
message SendVerificationCodeRequest {
  string email = 1 [(buf.validate.field).string.email = true];
}

message SendVerificationCodeResponse {
  bool success = 1;
  optional string error_message = 2;
}

// 检查用户是否存在并验证验证码
message CheckUserAndVerificationCodeRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string verification_code = 2 [(buf.validate.field).string.min_len = 1];
}

message CheckUserAndVerificationCodeResponse {
  bool user_exists = 1; // 用户是否已存在
  bool code_valid = 2; // 验证码是否正确
  optional string error_message = 3; // 错误消息："user_already_exists" 或 "invalid_verification_code"
}

// 创建用户和 Profile
message CreateUserWithProfileRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [(buf.validate.field).string.min_len = 6];
  string username = 3 [(buf.validate.field).string.min_len = 1, (buf.validate.field).string.max_len = 50];
  optional string phone = 4;
}

message CreateUserWithProfileResponse {
  string user_id = 1;
  string username = 2;
  string email = 3;
  optional string error_message = 4;
}

// 认证信息（嵌套用户、角色和资料信息）
message Auth {
  string id = 1; // 用户ID (UUID)
  string username = 2; // 用户名
  string email = 3; // 邮箱
  string phone = 4; // 手机号
  bool password_set = 5; // 是否已设置密码（不返回实际密码）
  AuthStatus status = 6; // 当前状态
  bool is_verified = 7; // 是否已验证
  optional google.protobuf.Timestamp last_login_at = 8; // 最后登录时间
  google.protobuf.Timestamp created_at = 9; // 创建时间
  google.protobuf.Timestamp updated_at = 10; // 更新时间
  optional google.protobuf.Timestamp deleted_at = 11; // 软删除时间
  
  // 嵌套的用户信息
  user.User user = 20;
  
  // 嵌套的角色信息（多对多关系，通过 user_roles 表关联）
  repeated role.Role roles = 21;
  
  // 嵌套的资料信息（通过 user_id preload）
  profile.Profile profile = 22;
}

